#!/bin/bash
# 빠른 GPU 파이프라인 (1시간 이내, 샘플 데이터 테스트)
# 데이터 누출 수정 버전

set -e

echo "======================================================================"
echo "빠른 GPU 파이프라인 (데이터 누출 수정, 1시간 이내)"
echo "======================================================================"
echo ""

# 설정
SAMPLE_FRAC=${1:-0.05}  # 기본 5% 샘플 (테스트용)
PYTHON_CMD="./run_gpu.sh"

echo "파이프라인 설정:"
echo "  - 데이터 샘플 비율: ${SAMPLE_FRAC}"
echo "  - 예상 소요 시간: ~10-30분 (5% 샘플 기준)"
echo "  - 수정 사항: MCC 피처 제거 (데이터 누출 방지)"
echo ""

# 단계 1: 전처리
echo "======================================================================"
echo "[단계 1/2] 전체 데이터 전처리 (MCC 피처 제외)"
echo "======================================================================"
echo ""

python3 01_src/00_preprocessing/01_preprocess_full.py

if [ $? -ne 0 ]; then
    echo "❌ 전처리 실패"
    exit 1
fi

echo ""
echo "✅ 전처리 완료 (18개 특성 생성, MCC 제외)"
echo ""

# 단계 2: 그리드 서치 (최적화 버전)
echo "======================================================================"
echo "[단계 2/2] GPU 그리드 서치 (최적화 버전)"
echo "======================================================================"
echo ""
echo "XGBoost: 27개 조합 (~20분)"
echo "RandomForest: 18개 조합 (~15분)"
echo ""

${PYTHON_CMD} 01_src/01_training/03_gridsearch_fast.py

if [ $? -ne 0 ]; then
    echo "❌ 그리드 서치 실패"
    exit 1
fi

echo ""
echo "✅ 그리드 서치 완료"
echo ""

# 최종 요약
echo "======================================================================"
echo "파이프라인 완료!"
echo "======================================================================"
echo ""
echo "📊 결과 확인:"
echo "  - 전처리 데이터: 02_data/01_processed/preprocessed_full_featured.csv"
echo "  - 그리드 서치 결과: 03_models/05_gridsearch/"
echo ""
echo "🔍 성능 검증:"
echo "  - F1 Score가 0.3-0.6 범위이면 정상 (데이터 누출 없음)"
echo "  - F1 Score가 1.0이면 여전히 문제 있음"
echo ""
echo "🎯 다음 단계:"
echo "  1. metadata_*.json에서 성능 확인"
echo "  2. F1 Score 검토 (과적합 여부 확인)"
echo "  3. 필요시 추가 피처 조정"
echo ""
